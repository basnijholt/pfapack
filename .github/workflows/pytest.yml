name: pytest
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    defaults:
      run:
        shell: bash -l {0}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: fortran-lang/setup-fortran@v1
      id: setup-fortran
      with:
        version: 12 # should be available on all runners

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y  libblas-dev liblapack-dev

    # - name: Install system dependencies (Windows)
    #   if: matrix.os == 'windows-latest'
    #   run: |
    #     # Install MinGW-w64 using rtools
    #     choco install rtools -y --no-progress --force --version=4.0.0.20220206
    #     echo "c:\rtools40\ucrt64\bin;" >> $env:GITHUB_PATH

    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-gcc-fortran
        path-type: minimal

    - name: Install OpenBLAS (Windows)
      if: matrix.os == 'windows-latest'
      shell: bash
      run: |
        # Install scipy-openblas32
        pip install scipy-openblas32
        # Create pkg-config file
        python -c "import scipy_openblas32 as sop; print(sop.get_pkg_config())" > openblas.pc
        # Set environment variables
        echo "PKG_CONFIG_PATH=$PWD" >> $GITHUB_ENV
        echo "OPENBLAS_NUM_THREADS=1" >> $GITHUB_ENV

    # NOTE: No MacOS specific install.
    # We'll use the Accelerate framework instead of installing BLAS/LAPACK

    - name: Build and run C/Fortran tests
      run: |
        # Print environment for debugging
        which gfortran
        gfortran --version

        # Install and run tests
        pip install -U meson pip ninja
        pip install -e . --config-settings=setup-args="-Dbuild_tests=enabled"
        cd build/cp* && meson test --verbose

    - name: Install test dependencies
      run: |
        pip install ".[test]"

    - name: Run Python tests
      run: |
        pytest tests --cov --cov-append --cov-report=term-missing

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
